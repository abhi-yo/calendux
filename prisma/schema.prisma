generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String   @id
  email              String   @unique
  timezone           String   @default("UTC")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  energyProfile      Json?
  name               String?
  preferences        Json?
  subscriptionStatus String?
  tier               Tier     @default(FREE)
  causes             Cause[]
  events             Event[]
}

model Event {
  id                 String          @id @default(cuid())
  title              String
  description        String?
  start              DateTime
  end                DateTime
  allDay             Boolean         @default(false)
  userId             String
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  causedById         String?
  energyCost         Int             @default(3)
  flexibility        Int             @default(3)
  importance         Int             @default(3)
  isRecurring        Boolean         @default(false)
  notes              String?
  recurrenceParentId String?
  recurrenceRule     String?
  tags               String[]
  type               EventType       @default(TASK)
  cognitiveLoad      Int             @default(3)
  contextTag         String?
  externalId         String?
  location           String?
  source             EventSource     @default(MANUAL)
  causedBy           Event?          @relation("CausalChain", fields: [causedById], references: [id])
  causes             Event[]         @relation("CausalChain")
  recurrenceParent   Event?          @relation("RecurrenceGroup", fields: [recurrenceParentId], references: [id])
  recurrenceChildren Event[]         @relation("RecurrenceGroup")
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  causedByEdges      EventCause[]
  outgoingRelations  EventRelation[] @relation("SourceEvent")
  incomingRelations  EventRelation[] @relation("TargetEvent")
  predictions        Prediction[]

  @@index([userId, start])
  @@index([causedById])
}

model Cause {
  id          String       @id @default(cuid())
  description String
  importance  Int          @default(3)
  userId      String
  createdAt   DateTime     @default(now())
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  events      EventCause[]
}

model EventCause {
  id           String   @id @default(cuid())
  causeId      String
  eventId      String
  confidence   Float    @default(1.0)
  relationType String   @default("GENERATED_BY")
  createdAt    DateTime @default(now())
  cause        Cause    @relation(fields: [causeId], references: [id], onDelete: Cascade)
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([causeId, eventId])
}

model EventRelation {
  id          String   @id @default(cuid())
  fromEventId String
  toEventId   String
  type        String
  weight      Float    @default(1.0)
  createdAt   DateTime @default(now())
  fromEvent   Event    @relation("SourceEvent", fields: [fromEventId], references: [id], onDelete: Cascade)
  toEvent     Event    @relation("TargetEvent", fields: [toEventId], references: [id], onDelete: Cascade)

  @@index([fromEventId])
  @@index([toEventId])
}

model Prediction {
  id            String         @id @default(cuid())
  eventId       String
  type          PredictionType
  predictedDate DateTime
  confidence    Float
  details       Json?
  createdAt     DateTime       @default(now())
  event         Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

enum Tier {
  FREE
  PRO
  TEAM
}

enum EventType {
  MEETING
  TASK
  HABIT
  FOCUS
  BREAK
  PERSONAL
}

enum EventSource {
  MANUAL
  GOOGLE
  NOTION
  TODOIST
  SLACK
}

enum PredictionType {
  BURNOUT
  CONFLICT
  OVERLOAD
}
